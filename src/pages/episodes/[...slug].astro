---
import Layout from '../../layouts/Layout.astro'
import AudioPlayer from '../../components/AudioPlayer.astro'
import YouTubeEmbed from '../../components/YouTubeEmbed.astro'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  const episodes = await getCollection('episodes')
  return episodes.map((episode) => ({
    params: { slug: episode.id },
    props: { episode },
  }))
}

const { episode } = Astro.props
const { Content } = await render(episode)

const formattedDate = episode.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
})

// Get adjacent episodes for navigation
const allEpisodes = await getCollection('episodes')
const sortedEpisodes = allEpisodes.sort((a, b) => b.data.number - a.data.number)
const currentIndex = sortedEpisodes.findIndex(e => e.id === episode.id)
const prevEpisode = sortedEpisodes[currentIndex + 1]
const nextEpisode = sortedEpisodes[currentIndex - 1]

const hasTranscript = !!episode.data.transcript
---

<Layout 
  title={`#${episode.data.number}: ${episode.data.title} - The Web Talk Show`}
  description={episode.data.description}
  image={episode.data.image}
>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <!-- Episode Header -->
    <header class="mb-8">
      <div class="flex items-center gap-2 text-sm text-slate-500 mb-4">
        <a href="/episodes" class="hover:text-indigo-600">Episodes</a>
        <span>/</span>
        <span>Episode #{episode.data.number}</span>
      </div>
      
      <h1 class="text-3xl md:text-4xl font-bold mb-4">{episode.data.title}</h1>
      
      <div class="flex flex-wrap items-center gap-4 text-slate-600 mb-6">
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {formattedDate}
        </span>
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {episode.data.duration}
        </span>
      </div>
      
      <!-- Guests -->
      {episode.data.guests && episode.data.guests.length > 0 && (
        <div class="flex items-center gap-2 text-slate-600 mb-6">
          <span class="font-medium">Guests:</span>
          <span>{episode.data.guests.join(', ')}</span>
        </div>
      )}
      
      <p class="text-lg text-slate-600">{episode.data.description}</p>
    </header>

    <!-- YouTube Embed -->
    {episode.data.youtubeUrl && (
      <div class="mb-8">
        <YouTubeEmbed url={episode.data.youtubeUrl} title={episode.data.title} />
      </div>
    )}

    <!-- Listen On Links -->
    <div class="mb-8">
      <AudioPlayer
        audioUrl={episode.data.audioUrl}
        spotifyUrl={episode.data.spotifyUrl}
        appleUrl={episode.data.appleUrl}
        youtubeUrl={episode.data.youtubeUrl}
        title={episode.data.title}
      />
    </div>

    <!-- Topics -->
    {episode.data.topics && episode.data.topics.length > 0 && (
      <div class="mb-8">
        <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3">Topics Covered</h2>
        <div class="flex flex-wrap gap-2">
          {episode.data.topics.map((topic) => (
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 text-sm rounded-full">{topic}</span>
          ))}
        </div>
      </div>
    )}

    <!-- Tabbed Content (Show Notes / Transcript) -->
    <div class="mb-12" x-data="{ tab: 'notes' }">
      <!-- Tab Buttons -->
      <div class="flex border-b border-slate-200 mb-6">
        <button 
          class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
          :class="tab === 'notes' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'"
          @click="tab = 'notes'"
        >
          Show Notes
        </button>
        {hasTranscript && (
          <button 
            class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
            :class="tab === 'transcript' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'"
            @click="tab = 'transcript'"
          >
            Transcript
          </button>
        )}
      </div>

      <!-- Show Notes Tab -->
      <div x-show="tab === 'notes'" class="prose prose-slate max-w-none">
        <Content />
      </div>

      <!-- Transcript Tab -->
      {hasTranscript && (
        <div x-show="tab === 'transcript'" x-cloak class="prose prose-slate max-w-none">
          <div class="bg-slate-50 rounded-xl p-6 text-sm leading-relaxed text-slate-700 whitespace-pre-wrap font-sans">
            {episode.data.transcript}
          </div>
        </div>
      )}
    </div>

    <!-- Navigation -->
    <nav class="border-t border-slate-200 pt-8">
      <div class="grid md:grid-cols-2 gap-4">
        {prevEpisode && (
          <a href={`/episodes/${prevEpisode.id}`} class="group p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-colors">
            <div class="text-sm text-slate-500 mb-1">← Previous Episode</div>
            <div class="font-medium group-hover:text-indigo-600">#{prevEpisode.data.number}: {prevEpisode.data.title}</div>
          </a>
        )}
        {nextEpisode && (
          <a href={`/episodes/${nextEpisode.id}`} class="group p-4 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-colors md:text-right md:ml-auto">
            <div class="text-sm text-slate-500 mb-1">Next Episode →</div>
            <div class="font-medium group-hover:text-indigo-600">#{nextEpisode.data.number}: {nextEpisode.data.title}</div>
          </a>
        )}
      </div>
    </nav>
  </article>
</Layout>

<!-- Alpine.js for tabs -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
  [x-cloak] { display: none !important; }
</style>
