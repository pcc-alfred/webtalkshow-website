---
import Layout from '../../layouts/Layout.astro'
import AudioPlayer from '../../components/AudioPlayer.astro'
import YouTubeEmbed from '../../components/YouTubeEmbed.astro'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  const episodes = await getCollection('episodes')
  return episodes.map((episode) => ({
    params: { slug: episode.id },
    props: { episode },
  }))
}

const { episode } = Astro.props
const { Content } = await render(episode)

const formattedDate = episode.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
})

const allEpisodes = await getCollection('episodes')
const sortedEpisodes = allEpisodes.sort((a, b) => b.data.number - a.data.number)
const currentIndex = sortedEpisodes.findIndex(e => e.id === episode.id)
const prevEpisode = sortedEpisodes[currentIndex + 1]
const nextEpisode = sortedEpisodes[currentIndex - 1]

const hasTranscript = !!episode.data.transcript

function getYouTubeThumbnail(url: string | undefined): string | null {
  if (!url) return null
  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)
  return match ? `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg` : null
}
const episodeImage = getYouTubeThumbnail(episode.data.youtubeUrl) || '/og-image.jpg'
const paddedNumber = String(episode.data.number).padStart(3, '0')

const episodeJsonLd = {
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "name": episode.data.title,
  "description": episode.data.description,
  "datePublished": episode.data.date.toISOString(),
  "duration": `PT${episode.data.duration.replace(':', 'M')}S`,
  "episodeNumber": episode.data.number,
  "image": episodeImage,
  "url": `https://webtalk.show/episodes/${episode.id}`,
  "partOfSeries": {
    "@type": "PodcastSeries",
    "name": "The Web Talk Show",
    "url": "https://webtalk.show"
  },
  "author": {
    "@type": "Person",
    "name": "Armando J. Perez-Carreno"
  }
}
---

<Layout 
  title={`#${episode.data.number}: ${episode.data.title} - The Web Talk Show`}
  description={episode.data.description}
  image={episodeImage}
>
  <script type="application/ld+json" set:html={JSON.stringify(episodeJsonLd)} />
  
  <!-- Cinematic header -->
  <div class="relative h-[200px] sm:h-[280px] overflow-hidden">
    {episodeImage && (
      <img src={episodeImage} alt="" class="w-full h-full object-cover" loading="eager" />
    )}
    <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-[#0a0a0a]/70 to-[#0a0a0a]/20"></div>
    
    <!-- Oversized watermark number -->
    <div class="absolute bottom-0 right-4 sm:right-8 font-[var(--font-display)] font-extrabold text-[8rem] sm:text-[12rem] leading-none text-white/[0.04] select-none pointer-events-none">
      {paddedNumber}
    </div>
  </div>
  
  <article class="max-w-4xl mx-auto px-4 sm:px-6 -mt-12 relative z-10 pb-16">
    <!-- Episode Header -->
    <header class="mb-8">
      <div class="flex items-center gap-2 text-sm text-[#8a8a8a] mb-4">
        <a href="/episodes" class="hover:text-[#e63329] transition-colors">Episodes</a>
        <span class="text-white/20">/</span>
        <span class="text-[#e63329]">#{episode.data.number}</span>
      </div>
      
      <h1 class="font-[var(--font-display)] font-extrabold text-white text-3xl sm:text-4xl leading-tight mb-5 tracking-tight">{episode.data.title}</h1>
      
      <div class="flex flex-wrap items-center gap-4 text-[#8a8a8a] mb-6">
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4 text-[#8a8a8a]/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {formattedDate}
        </span>
        <span class="text-white/10">Â·</span>
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4 text-[#8a8a8a]/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {episode.data.duration}
        </span>
      </div>
      
      {episode.data.guests && episode.data.guests.length > 0 && (
        <div class="flex items-center gap-2 text-[#8a8a8a] mb-6">
          <span class="text-white/60 font-medium">Guests:</span>
          <span>{episode.data.guests.join(', ')}</span>
        </div>
      )}
      
      <p class="text-lg text-[#d4d4d4]/80 leading-relaxed">{episode.data.description}</p>
    </header>

    <!-- YouTube Embed -->
    {episode.data.youtubeUrl && (
      <div class="mb-8 rounded-xl overflow-hidden border border-white/5">
        <YouTubeEmbed url={episode.data.youtubeUrl} title={episode.data.title} />
      </div>
    )}

    <!-- Listen On Links -->
    <div class="mb-8">
      <AudioPlayer
        audioUrl={episode.data.audioUrl}
        spotifyUrl={episode.data.spotifyUrl}
        appleUrl={episode.data.appleUrl}
        youtubeUrl={episode.data.youtubeUrl}
        title={episode.data.title}
      />
    </div>

    <!-- Topics -->
    {episode.data.topics && episode.data.topics.length > 0 && (
      <div class="mb-8">
        <h2 class="text-xs font-semibold text-[#8a8a8a] uppercase tracking-[0.15em] mb-3">Topics Covered</h2>
        <div class="flex flex-wrap gap-2">
          {episode.data.topics.map((topic) => (
            <span class="px-3 py-1 bg-[#e63329]/10 text-[#e63329] text-sm rounded-full border border-[#e63329]/15 shadow-[0_0_12px_rgba(230,51,41,0.08)]">{topic}</span>
          ))}
        </div>
      </div>
    )}

    <!-- Tabbed Content -->
    <div class="mb-12" x-data="{ tab: 'notes' }">
      <div class="flex border-b border-white/10 mb-6">
        <button 
          class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
          :class="tab === 'notes' ? 'border-[#e63329] text-[#e63329]' : 'border-transparent text-[#8a8a8a] hover:text-white'"
          @click="tab = 'notes'"
        >
          Show Notes
        </button>
        {hasTranscript && (
          <button 
            class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
            :class="tab === 'transcript' ? 'border-[#e63329] text-[#e63329]' : 'border-transparent text-[#8a8a8a] hover:text-white'"
            @click="tab = 'transcript'"
          >
            Transcript
          </button>
        )}
      </div>

      <div x-show="tab === 'notes'" class="prose max-w-none">
        <Content />
      </div>

      {hasTranscript && (
        <div x-show="tab === 'transcript'" x-cloak class="prose max-w-none">
          <div class="bg-[#1a1a1a] rounded-xl p-6 text-sm leading-relaxed text-[#d4d4d4]/80 whitespace-pre-wrap border border-white/5">
            {episode.data.transcript}
          </div>
        </div>
      )}
    </div>

    <!-- Navigation -->
    <nav class="border-t border-white/5 pt-8">
      <div class="grid md:grid-cols-2 gap-4">
        {prevEpisode && (
          <a href={`/episodes/${prevEpisode.id}`} class="group p-5 bg-[#1a1a1a] border border-white/5 rounded-xl hover:border-[#e63329]/30 hover:bg-[#1a1a1a] transition-all">
            <div class="text-xs text-[#8a8a8a] mb-2 flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              Previous Episode
            </div>
            <div class="font-[var(--font-display)] font-bold text-white group-hover:text-[#e63329] transition-colors">#{prevEpisode.data.number}: {prevEpisode.data.title}</div>
          </a>
        )}
        {nextEpisode && (
          <a href={`/episodes/${nextEpisode.id}`} class="group p-5 bg-[#1a1a1a] border border-white/5 rounded-xl hover:border-[#e63329]/30 hover:bg-[#1a1a1a] transition-all md:text-right md:ml-auto">
            <div class="text-xs text-[#8a8a8a] mb-2 flex items-center gap-1 md:justify-end">
              Next Episode
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </div>
            <div class="font-[var(--font-display)] font-bold text-white group-hover:text-[#e63329] transition-colors">#{nextEpisode.data.number}: {nextEpisode.data.title}</div>
          </a>
        )}
      </div>
    </nav>
  </article>
</Layout>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
  [x-cloak] { display: none !important; }
</style>
