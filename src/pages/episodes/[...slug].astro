---
import Layout from '../../layouts/Layout.astro'
import AudioPlayer from '../../components/AudioPlayer.astro'
import YouTubeEmbed from '../../components/YouTubeEmbed.astro'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  const episodes = await getCollection('episodes')
  return episodes.map((episode) => ({
    params: { slug: episode.id },
    props: { episode },
  }))
}

const { episode } = Astro.props
const { Content } = await render(episode)

const formattedDate = episode.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
})

// Get adjacent episodes for navigation
const allEpisodes = await getCollection('episodes')
const sortedEpisodes = allEpisodes.sort((a, b) => b.data.number - a.data.number)
const currentIndex = sortedEpisodes.findIndex(e => e.id === episode.id)
const prevEpisode = sortedEpisodes[currentIndex + 1]
const nextEpisode = sortedEpisodes[currentIndex - 1]

const hasTranscript = !!episode.data.transcript

// YouTube thumbnail for episode image
function getYouTubeThumbnail(url: string | undefined): string | null {
  if (!url) return null
  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)
  return match ? `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg` : null
}
const episodeImage = getYouTubeThumbnail(episode.data.youtubeUrl) || '/og-image.jpg'

// JSON-LD for episode
const episodeJsonLd = {
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "name": episode.data.title,
  "description": episode.data.description,
  "datePublished": episode.data.date.toISOString(),
  "duration": `PT${episode.data.duration.replace(':', 'M')}S`,
  "episodeNumber": episode.data.number,
  "image": episodeImage,
  "url": `https://webtalk.show/episodes/${episode.id}`,
  "partOfSeries": {
    "@type": "PodcastSeries",
    "name": "The Web Talk Show",
    "url": "https://webtalk.show"
  },
  "author": {
    "@type": "Person",
    "name": "Armando J. Perez-Carreno"
  }
}
---

<Layout 
  title={`#${episode.data.number}: ${episode.data.title} - The Web Talk Show`}
  description={episode.data.description}
  image={episodeImage}
>
  <!-- Episode JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify(episodeJsonLd)} />
  
  <article class="max-w-4xl mx-auto px-4 py-12">
    <!-- Episode Header -->
    <header class="mb-8">
      <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-4">
        <a href="/episodes" class="hover:text-indigo-600 dark:hover:text-indigo-400">Episodes</a>
        <span>/</span>
        <span>Episode #{episode.data.number}</span>
      </div>
      
      <h1 class="text-3xl md:text-4xl font-bold mb-4 dark:text-white">{episode.data.title}</h1>
      
      <div class="flex flex-wrap items-center gap-4 text-slate-600 dark:text-slate-400 mb-6">
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {formattedDate}
        </span>
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {episode.data.duration}
        </span>
      </div>
      
      <!-- Guests -->
      {episode.data.guests && episode.data.guests.length > 0 && (
        <div class="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-6">
          <span class="font-medium">Guests:</span>
          <span>{episode.data.guests.join(', ')}</span>
        </div>
      )}
      
      <p class="text-lg text-slate-600 dark:text-slate-300">{episode.data.description}</p>
    </header>

    <!-- YouTube Embed -->
    {episode.data.youtubeUrl && (
      <div class="mb-8">
        <YouTubeEmbed url={episode.data.youtubeUrl} title={episode.data.title} />
      </div>
    )}

    <!-- Listen On Links -->
    <div class="mb-8">
      <AudioPlayer
        audioUrl={episode.data.audioUrl}
        spotifyUrl={episode.data.spotifyUrl}
        appleUrl={episode.data.appleUrl}
        youtubeUrl={episode.data.youtubeUrl}
        title={episode.data.title}
      />
    </div>

    <!-- Topics -->
    {episode.data.topics && episode.data.topics.length > 0 && (
      <div class="mb-8">
        <h2 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">Topics Covered</h2>
        <div class="flex flex-wrap gap-2">
          {episode.data.topics.map((topic) => (
            <span class="px-3 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-sm rounded-full">{topic}</span>
          ))}
        </div>
      </div>
    )}

    <!-- Tabbed Content (Show Notes / Transcript) -->
    <div class="mb-12" x-data="{ tab: 'notes' }">
      <!-- Tab Buttons -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
        <button 
          class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
          :class="tab === 'notes' ? 'border-indigo-600 text-indigo-600 dark:border-indigo-400 dark:text-indigo-400' : 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'"
          @click="tab = 'notes'"
        >
          Show Notes
        </button>
        {hasTranscript && (
          <button 
            class="px-4 py-3 font-medium text-sm border-b-2 transition-colors"
            :class="tab === 'transcript' ? 'border-indigo-600 text-indigo-600 dark:border-indigo-400 dark:text-indigo-400' : 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'"
            @click="tab = 'transcript'"
          >
            Transcript
          </button>
        )}
      </div>

      <!-- Show Notes Tab -->
      <div x-show="tab === 'notes'" class="prose prose-slate dark:prose-invert max-w-none">
        <Content />
      </div>

      <!-- Transcript Tab -->
      {hasTranscript && (
        <div x-show="tab === 'transcript'" x-cloak class="prose prose-slate dark:prose-invert max-w-none">
          <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-6 text-sm leading-relaxed text-slate-700 dark:text-slate-300 whitespace-pre-wrap font-sans">
            {episode.data.transcript}
          </div>
        </div>
      )}
    </div>

    <!-- Navigation -->
    <nav class="border-t border-slate-200 dark:border-slate-700 pt-8">
      <div class="grid md:grid-cols-2 gap-4">
        {prevEpisode && (
          <a href={`/episodes/${prevEpisode.id}`} class="group p-4 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors">
            <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">← Previous Episode</div>
            <div class="font-medium group-hover:text-indigo-600 dark:text-white dark:group-hover:text-indigo-400">#{prevEpisode.data.number}: {prevEpisode.data.title}</div>
          </a>
        )}
        {nextEpisode && (
          <a href={`/episodes/${nextEpisode.id}`} class="group p-4 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors md:text-right md:ml-auto">
            <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Next Episode →</div>
            <div class="font-medium group-hover:text-indigo-600 dark:text-white dark:group-hover:text-indigo-400">#{nextEpisode.data.number}: {nextEpisode.data.title}</div>
          </a>
        )}
      </div>
    </nav>
  </article>
</Layout>

<!-- Alpine.js for tabs -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
  [x-cloak] { display: none !important; }
</style>
