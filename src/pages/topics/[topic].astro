---
import Layout from '../../layouts/Layout.astro'
import EpisodeCard from '../../components/EpisodeCard.astro'
import { getCollection } from 'astro:content'

export async function getStaticPaths() {
  const allEpisodes = await getCollection('episodes')
  
  const topicMap = new Map<string, typeof allEpisodes>()
  const slugToName = new Map<string, string>()
  
  for (const ep of allEpisodes) {
    for (const topic of ep.data.topics || []) {
      const slug = topic.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
      if (!topicMap.has(slug)) topicMap.set(slug, [])
      topicMap.get(slug)!.push(ep)
      slugToName.set(slug, topic)
    }
  }

  return [...topicMap.entries()].map(([slug, episodes]) => ({
    params: { topic: slug },
    props: { 
      topicName: slugToName.get(slug)!, 
      episodes: episodes.sort((a, b) => b.data.number - a.data.number) 
    },
  }))
}

const { topicName, episodes } = Astro.props
const topicSlug = topicName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')

const topicDescriptions: Record<string, string> = {
  'AI': 'Episodes exploring artificial intelligence applications in business, including automation, machine learning, AI-powered tools, and the practical impact of AI on different industries.',
  'Design': 'Conversations about design thinking, user experience, visual design, and how design decisions shape products and businesses.',
  'Business': 'Episodes covering business strategy, operations, scaling, entrepreneurship, and the realities of building and running companies.',
  'Leadership': 'Discussions about team building, management, decision-making, and the leadership lessons learned by founders and executives.',
  'WordPress': 'Deep dives into WordPress development, the block editor, Gutenberg, themes, plugins, and the WordPress ecosystem.',
  'Automation': 'Episodes about automating business processes, workflows, and operations using software and AI-powered systems.',
  'Web Development': 'Conversations about building for the web — frontend, backend, frameworks, performance, and modern development practices.',
  'Performance': 'Episodes focused on web performance, speed optimization, and building fast, efficient digital experiences.',
  'Hosting': 'Discussions about web hosting infrastructure, platforms, deployment strategies, and server management.',
  'Privacy': 'Episodes covering digital privacy, data protection, and building products that respect user privacy.',
  'Affiliate Marketing': 'Conversations about affiliate marketing strategies, partnerships, and building revenue through referral programs.',
}

const description = topicDescriptions[topicName] || 
  `Episodes of The Web Talk Show covering ${topicName}. ${episodes.length} episode${episodes.length !== 1 ? 's' : ''} exploring this topic through interviews with industry professionals.`

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://webtalk.show" },
    { "@type": "ListItem", "position": 2, "name": "Topics", "item": "https://webtalk.show/topics" },
    { "@type": "ListItem", "position": 3, "name": topicName, "item": `https://webtalk.show/topics/${topicSlug}` }
  ]
}
---

<Layout
  title={`${topicName} - Topics - The Web Talk Show`}
  description={description}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
  
  <div class="pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <header class="mb-10">
        <div class="flex items-center gap-2 text-sm mb-4" style="color: var(--text-muted);">
          <a href="/" class="hover:text-[#e63329] transition-colors">Home</a>
          <span style="color: var(--border);">/</span>
          <a href="/topics" class="hover:text-[#e63329] transition-colors">Topics</a>
          <span style="color: var(--border);">/</span>
          <span class="text-[#e63329]">{topicName}</span>
        </div>
        <h1 class="font-[var(--font-display)] font-extrabold text-4xl sm:text-5xl tracking-tight mb-4" style="color: var(--text-heading);">{topicName}</h1>
        <p class="text-lg leading-relaxed" style="color: var(--text); opacity: 0.8;">{description}</p>
        <p class="text-sm mt-3" style="color: var(--text-muted);">{episodes.length} episode{episodes.length !== 1 ? 's' : ''}</p>
      </header>

      <div class="space-y-1">
        {episodes.map((ep, i) => (
          <EpisodeCard
            number={ep.data.number}
            title={ep.data.title}
            description={ep.data.description}
            date={ep.data.date}
            duration={ep.data.duration}
            slug={ep.id}
            guests={ep.data.guests}
            topics={ep.data.topics}
            index={i}
          />
        ))}
      </div>

      <div class="mt-12 text-center">
        <a href="/topics" class="text-[#e63329] hover:text-[#c42a22] text-sm font-semibold transition-colors">
          ← All Topics
        </a>
      </div>
    </div>
  </div>
</Layout>
