---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'

export async function getStaticPaths() {
  const episodes = await getCollection('episodes')
  
  // Build a map of topics
  const topicsMap = new Map<string, any[]>()
  
  episodes.forEach(episode => {
    const topics = episode.data.topics || []
    topics.forEach(topic => {
      const slug = topic.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '')
      if (!topicsMap.has(slug)) {
        topicsMap.set(slug, [])
      }
      topicsMap.get(slug)?.push({
        ...episode,
        topicName: topic
      })
    })
  })
  
  // Generate paths
  return Array.from(topicsMap.entries()).map(([slug, episodes]) => ({
    params: { topic: slug },
    props: { 
      episodes: episodes.sort((a, b) => 
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
      ),
      topicName: episodes[0].topicName
    }
  }))
}

const { episodes, topicName } = Astro.props
const { topic } = Astro.params

// Topic descriptions
const topicDescriptions: Record<string, string> = {
  'wordpress': 'Episodes exploring WordPress development, the block editor (Gutenberg), plugins, themes, and the WordPress ecosystem. Learn from developers and agencies building with WordPress.',
  'interactivity-api': 'Deep dives into the WordPress Interactivity API, a framework for creating interactive and dynamic blocks with a declarative, reactive approach to frontend development.',
  'gutenberg': 'Conversations about the WordPress block editor, including block development, full site editing, and the evolving WordPress editing experience.',
  'ai': 'Discussions about artificial intelligence, machine learning, automation, and how AI is transforming business operations and software development.',
  'business-operations': 'Insights into running and scaling businesses, operational systems, process optimization, and the behind-the-scenes work that makes companies function.',
  'design': 'Episodes covering design systems, user experience, visual design, and the craft of creating digital products.',
  'marketing': 'Conversations about marketing strategies, growth, content creation, and building audiences.',
  'leadership': 'Discussions about team leadership, management, organizational culture, and building effective teams.'
}

const description = topicDescriptions[topic] || `Explore all episodes about ${topicName} on The Web Talk Show. Conversations with industry professionals sharing practical insights and behind-the-scenes knowledge.`

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `${topicName} - The Web Talk Show`,
  "description": description,
  "url": `https://webtalk.show/topics/${topic}`,
  "isPartOf": {
    "@type": "WebSite",
    "name": "The Web Talk Show",
    "url": "https://webtalk.show"
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://webtalk.show"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Topics",
        "item": "https://webtalk.show/topics"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": topicName,
        "item": `https://webtalk.show/topics/${topic}`
      }
    ]
  }
}

function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  })
}
---

<Layout 
  title={`${topicName} - The Web Talk Show`}
  description={description}
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  
  <div class="pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Breadcrumb -->
      <nav class="mb-6 text-sm" style="color: var(--text-muted);">
        <a href="/" class="hover:text-[#e63329] transition-colors">Home</a>
        <span class="mx-2">/</span>
        <a href="/topics" class="hover:text-[#e63329] transition-colors">Topics</a>
        <span class="mx-2">/</span>
        <span style="color: var(--text);">{topicName}</span>
      </nav>
      
      <h1 class="font-[var(--font-display)] font-extrabold text-4xl sm:text-5xl tracking-tight mb-4" style="color: var(--text-heading);">
        {topicName}
      </h1>
      
      <p class="text-lg mb-10 leading-relaxed" style="color: var(--text-muted);">
        {description}
      </p>
      
      <div class="space-y-6">
        {episodes.map((episode: any) => (
          <article class="episode-card p-6 rounded-xl border transition-all duration-200" style="background: var(--bg-elevated); border-color: var(--border);">
            <a href={`/episodes/${episode.slug}`} class="group">
              <div class="flex items-start gap-4">
                <span class="episode-number flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center font-[var(--font-display)] font-bold text-lg transition-all" style="background: var(--number-color); color: var(--text-muted);">
                  {episode.data.number}
                </span>
                <div class="flex-1 min-w-0">
                  <h2 class="font-[var(--font-display)] text-xl font-bold mb-2 group-hover:text-[#e63329] transition-colors" style="color: var(--text-heading);">
                    {episode.data.title}
                  </h2>
                  
                  <div class="flex flex-wrap items-center gap-3 text-sm mb-3" style="color: var(--text-muted);">
                    {episode.data.guests && episode.data.guests.length > 0 && (
                      <span>with {episode.data.guests.join(', ')}</span>
                    )}
                    <span>•</span>
                    <time datetime={episode.data.date.toISOString()}>
                      {formatDate(episode.data.date)}
                    </time>
                    {episode.data.duration && (
                      <>
                        <span>•</span>
                        <span>{episode.data.duration}</span>
                      </>
                    )}
                  </div>
                  
                  <p class="text-sm leading-relaxed mb-4" style="color: var(--text);">
                    {episode.data.description}
                  </p>
                  
                  {episode.data.topics && episode.data.topics.length > 1 && (
                    <div class="flex flex-wrap gap-2">
                      {episode.data.topics
                        .filter((t: string) => t !== topicName)
                        .slice(0, 4)
                        .map((t: string) => (
                          <span class="text-xs px-2 py-1 rounded-md" style="background: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--tag-border);">
                            {t}
                          </span>
                        ))
                      }
                    </div>
                  )}
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    </div>
  </div>
</Layout>

<style>
  .episode-card:hover {
    transform: translateY(-2px);
    border-color: rgba(230, 51, 41, 0.2) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  
  .dark .episode-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  .episode-card:hover .episode-number {
    background: var(--number-hover) !important;
    color: #e63329 !important;
  }
</style>
