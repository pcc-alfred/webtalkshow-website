---
import Layout from '../../layouts/Layout.astro'
import { getCollection } from 'astro:content'

const BAD_NAMES = new Set(['Atomic Blocks', 'Your Documents'])

export async function getStaticPaths() {
  const allEpisodes = await getCollection('episodes')
  const badNames = new Set(['Atomic Blocks', 'Your Documents'])
  
  const guestMap = new Map<string, typeof allEpisodes>()
  const slugToName = new Map<string, string>()
  
  for (const ep of allEpisodes) {
    for (const guest of ep.data.guests || []) {
      if (badNames.has(guest)) continue
      const slug = guest.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
      if (!guestMap.has(slug)) guestMap.set(slug, [])
      guestMap.get(slug)!.push(ep)
      slugToName.set(slug, guest)
    }
  }

  return [...guestMap.entries()].map(([slug, episodes]) => ({
    params: { guest: slug },
    props: {
      guestName: slugToName.get(slug)!,
      episodes: episodes.sort((a, b) => b.data.number - a.data.number),
    },
  }))
}

const { guestName, episodes } = Astro.props
const guestSlug = guestName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')

const allTopics = [...new Set(episodes.flatMap((ep: any) => ep.data.topics || []))]

const description = `${guestName} has appeared on ${episodes.length} episode${episodes.length !== 1 ? 's' : ''} of The Web Talk Show, discussing ${allTopics.slice(0, 3).join(', ')}${allTopics.length > 3 ? ', and more' : ''}.`

const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": guestName,
  "description": description,
  "url": `https://webtalk.show/guests/${guestSlug}`
}

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://webtalk.show" },
    { "@type": "ListItem", "position": 2, "name": "Guests", "item": "https://webtalk.show/guests" },
    { "@type": "ListItem", "position": 3, "name": guestName, "item": `https://webtalk.show/guests/${guestSlug}` }
  ]
}
---

<Layout
  title={`${guestName} - Guests - The Web Talk Show`}
  description={description}
>
  <script type="application/ld+json" set:html={JSON.stringify(personJsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />

  <div class="pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <header class="mb-10">
        <div class="flex items-center gap-2 text-sm mb-4" style="color: var(--text-muted);">
          <a href="/" class="hover:text-[#e63329] transition-colors">Home</a>
          <span style="color: var(--border);">/</span>
          <a href="/guests" class="hover:text-[#e63329] transition-colors">Guests</a>
          <span style="color: var(--border);">/</span>
          <span class="text-[#e63329]">{guestName}</span>
        </div>

        <div class="flex items-center gap-5 mb-6">
          <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold shrink-0" style="background: var(--tag-bg); color: var(--text-muted);">
            {guestName.split(' ').map((n: string) => n[0]).join('').slice(0, 2)}
          </div>
          <div>
            <h1 class="font-[var(--font-display)] font-extrabold text-3xl sm:text-4xl tracking-tight" style="color: var(--text-heading);">{guestName}</h1>
            <p class="text-sm mt-1" style="color: var(--text-muted);">{episodes.length} episode{episodes.length !== 1 ? 's' : ''} on The Web Talk Show</p>
          </div>
        </div>

        {allTopics.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {allTopics.map((topic: string) => {
              const topicSlug = topic.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
              return (
                <a href={`/topics/${topicSlug}`} class="px-3 py-1 text-sm rounded-full transition-colors hover:text-[#e63329]" style="background: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--tag-border);">
                  {topic}
                </a>
              )
            })}
          </div>
        )}
      </header>

      <h2 class="text-xs font-semibold uppercase tracking-[0.15em] mb-6" style="color: var(--text-muted);">Episodes</h2>

      <div class="space-y-1">
        {episodes.map((ep: any) => {
          const formattedDate = ep.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
          return (
            <a href={`/episodes/${ep.id}`} class="group block py-5 px-4 sm:px-6 rounded-lg transition-all" style="border-bottom: 1px solid var(--border);">
              <div class="flex items-start gap-4">
                <span class="font-[var(--font-display)] text-3xl font-extrabold shrink-0 w-14 transition-colors duration-500 select-none" style="color: var(--number-color);">
                  {String(ep.data.number).padStart(2, '0')}
                </span>
                <div class="flex-1 min-w-0">
                  <h3 class="font-[var(--font-display)] font-bold text-lg leading-snug mb-1 group-hover:text-[#e63329] transition-colors" style="color: var(--text-heading);">{ep.data.title}</h3>
                  <p class="text-sm line-clamp-2 mb-2" style="color: var(--text-muted);">{ep.data.description}</p>
                  <div class="flex flex-wrap items-center gap-3 text-xs" style="color: var(--text-muted);">
                    <span>{formattedDate}</span>
                    <span style="color: var(--border);">·</span>
                    <span>{ep.data.duration}</span>
                  </div>
                </div>
              </div>
            </a>
          )
        })}
      </div>

      <div class="mt-12 text-center">
        <a href="/guests" class="text-[#e63329] hover:text-[#c42a22] text-sm font-semibold transition-colors">
          ← All Guests
        </a>
      </div>
    </div>
  </div>
</Layout>
