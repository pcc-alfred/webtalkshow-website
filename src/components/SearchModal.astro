---
// SearchModal.astro - cmd+K style search popover with Pagefind
---

<!-- Search Modal Backdrop -->
<div 
  id="search-modal-backdrop" 
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-200"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Modal Container -->
  <div class="fixed inset-x-4 top-[10vh] md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-2xl z-50">
    <div id="search-modal" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden transform scale-95 opacity-0 transition-all duration-200">
      <h2 id="search-modal-title" class="sr-only">Search episodes</h2>
      <!-- Search Header -->
      <div class="flex items-center gap-3 px-4 py-3 border-b border-slate-200 dark:border-slate-700">
        <svg class="w-5 h-5 text-slate-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <label for="search-input" class="sr-only">Search episodes</label>
        <input 
          type="text" 
          id="search-input"
          placeholder="Search episodes..."
          class="flex-1 text-lg outline-none bg-transparent placeholder:text-slate-400 dark:placeholder:text-slate-500 dark:text-white focus:ring-0"
          autocomplete="off"
          autocapitalize="off"
          aria-describedby="search-empty"
        />
        <kbd class="hidden sm:inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-700 dark:text-slate-400 rounded">
          ESC
        </kbd>
      </div>
      
      <!-- Search Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- Initial state -->
        <div id="search-empty" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400">
          <p>Type to search episodes, show notes, and transcripts</p>
          <p class="text-sm mt-2 text-slate-400 dark:text-slate-500">
            <kbd class="px-1.5 py-0.5 text-xs bg-slate-100 dark:bg-slate-700 rounded">↑</kbd>
            <kbd class="px-1.5 py-0.5 text-xs bg-slate-100 dark:bg-slate-700 rounded">↓</kbd>
            to navigate
            <kbd class="px-1.5 py-0.5 text-xs bg-slate-100 dark:bg-slate-700 rounded ml-2">↵</kbd>
            to select
          </p>
        </div>
        
        <!-- Loading state -->
        <div id="search-loading" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400 hidden">
          <div class="inline-flex items-center gap-2">
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Searching...
          </div>
        </div>
        
        <!-- No results -->
        <div id="search-no-results" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400 hidden">
          No results found
        </div>
        
        <!-- Results list -->
        <ul id="search-results-list" class="divide-y divide-slate-100 dark:divide-slate-700 hidden"></ul>
      </div>
      
      <!-- Footer -->
      <div class="px-4 py-2 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-xs text-slate-400 flex items-center justify-between">
        <span>Powered by PerezCarreno & Coindreau</span>
        <span class="hidden sm:inline">
          <kbd class="px-1.5 py-0.5 bg-slate-200 dark:bg-slate-700 rounded">⌘</kbd>
          <kbd class="px-1.5 py-0.5 bg-slate-200 dark:bg-slate-700 rounded">K</kbd>
          to toggle
        </span>
      </div>
    </div>
  </div>
</div>

<style is:global>
  #search-results-list li {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.15s;
  }
  
  #search-results-list li:hover,
  #search-results-list li.selected {
    background-color: rgb(238 242 255); /* indigo-50 */
  }
  
  .dark #search-results-list li:hover,
  .dark #search-results-list li.selected {
    background-color: rgb(51 65 85); /* slate-700 */
  }
  
  #search-results-list li.selected {
    background-color: rgb(224 231 255); /* indigo-100 */
  }
  
  .dark #search-results-list li.selected {
    background-color: rgb(71 85 105); /* slate-600 */
  }
  
  #search-results-list .result-title {
    font-weight: 600;
    color: rgb(15 23 42); /* slate-900 */
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
  }
  
  .dark #search-results-list .result-title {
    color: rgb(255 255 255); /* white */
  }
  
  #search-results-list .result-excerpt {
    font-size: 0.875rem;
    color: rgb(71 85 105); /* slate-600 */
    margin-top: 0.25rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
  
  .dark #search-results-list .result-excerpt {
    color: rgb(203 213 225); /* slate-300 */
  }
  
  #search-results-list mark {
    background-color: rgb(254 240 138); /* yellow-200 */
    color: inherit;
    border-radius: 0.125rem;
    padding: 0 0.125rem;
  }
  
  .dark #search-results-list mark {
    background-color: rgb(202 138 4); /* yellow-600 */
    color: rgb(255 255 255);
  }
  
  /* Sub-results */
  #search-results-list .sub-results {
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid rgb(226 232 240); /* slate-200 */
  }
  
  .dark #search-results-list .sub-results {
    border-left-color: rgb(71 85 105); /* slate-600 */
  }
  
  #search-results-list .sub-results > * + * {
    margin-top: 0.25rem;
  }
  
  #search-results-list .sub-result {
    font-size: 0.875rem;
    color: rgb(71 85 105); /* slate-600 */
  }
  
  .dark #search-results-list .sub-result {
    color: rgb(148 163 184); /* slate-400 */
  }
  
  #search-results-list .sub-result:hover {
    color: rgb(79 70 229); /* indigo-600 */
  }
  
  .dark #search-results-list .sub-result:hover {
    color: rgb(129 140 248); /* indigo-400 */
  }
</style>

<script>
  let pagefind: any = null;
  let selectedIndex = -1;
  let results: any[] = [];
  
  const backdrop = document.getElementById('search-modal-backdrop')!;
  const modal = document.getElementById('search-modal')!;
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsList = document.getElementById('search-results-list')!;
  const emptyState = document.getElementById('search-empty')!;
  const loadingState = document.getElementById('search-loading')!;
  const noResults = document.getElementById('search-no-results')!;
  
  // Initialize Pagefind
  async function initPagefind() {
    if (pagefind) return pagefind;
    try {
      // Use dynamic import with variable to prevent Vite from bundling
      const pagefindPath = '/pagefind/pagefind.js';
      pagefind = await import(/* @vite-ignore */ pagefindPath);
      await pagefind.options({ excerptLength: 15 });
      return pagefind;
    } catch (e) {
      console.error('Failed to load Pagefind:', e);
      return null;
    }
  }
  
  // Open modal
  function openSearch() {
    backdrop.classList.remove('hidden');
    requestAnimationFrame(() => {
      backdrop.classList.remove('opacity-0');
      modal.classList.remove('scale-95', 'opacity-0');
    });
    input.focus();
    document.body.style.overflow = 'hidden';
    initPagefind();
  }
  
  // Close modal
  function closeSearch() {
    backdrop.classList.add('opacity-0');
    modal.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      backdrop.classList.add('hidden');
      input.value = '';
      resetResults();
    }, 200);
    document.body.style.overflow = '';
  }
  
  // Reset results display
  function resetResults() {
    results = [];
    selectedIndex = -1;
    resultsList.innerHTML = '';
    resultsList.classList.add('hidden');
    loadingState.classList.add('hidden');
    noResults.classList.add('hidden');
    emptyState.classList.remove('hidden');
  }
  
  // Perform search
  let searchTimeout: number;
  async function performSearch(query: string) {
    if (!query.trim()) {
      resetResults();
      return;
    }
    
    const pf = await initPagefind();
    if (!pf) return;
    
    // Show loading
    emptyState.classList.add('hidden');
    noResults.classList.add('hidden');
    resultsList.classList.add('hidden');
    loadingState.classList.remove('hidden');
    
    const search = await pf.search(query);
    results = search.results.slice(0, 10);
    
    loadingState.classList.add('hidden');
    
    if (results.length === 0) {
      noResults.classList.remove('hidden');
      return;
    }
    
    // Render results
    resultsList.innerHTML = '';
    for (let i = 0; i < results.length; i++) {
      const data = await results[i].data();
      const li = document.createElement('li');
      li.dataset.index = String(i);
      li.dataset.url = data.meta?.url || data.url;
      
      let html = `
        <div class="result-title">${data.meta?.title || 'Untitled'}</div>
        <div class="result-excerpt">${data.excerpt}</div>
      `;
      
      // Add sub-results if available
      if (data.sub_results && data.sub_results.length > 1) {
        html += '<div class="sub-results">';
        const subs = data.sub_results.slice(1, 4);
        for (const sub of subs) {
          html += `<a href="${sub.url}" class="sub-result block">${sub.title}</a>`;
        }
        html += '</div>';
      }
      
      li.innerHTML = html;
      li.addEventListener('click', () => navigateToResult(i));
      resultsList.appendChild(li);
    }
    
    resultsList.classList.remove('hidden');
    selectedIndex = -1;
  }
  
  // Navigate to selected result
  function navigateToResult(index: number) {
    if (results[index]) {
      results[index].data().then((data: any) => {
        window.location.href = data.meta?.url || data.url;
      });
    }
  }
  
  // Update selection highlight
  function updateSelection() {
    const items = resultsList.querySelectorAll('li');
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === selectedIndex);
    });
    
    // Scroll into view
    if (selectedIndex >= 0 && items[selectedIndex]) {
      items[selectedIndex].scrollIntoView({ block: 'nearest' });
    }
  }
  
  // Keyboard navigation
  function handleKeyDown(e: KeyboardEvent) {
    if (!backdrop.classList.contains('hidden')) {
      if (e.key === 'Escape') {
        closeSearch();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (results.length > 0) {
          selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
          updateSelection();
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (results.length > 0) {
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateSelection();
        }
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        navigateToResult(selectedIndex);
      }
    }
    
    // cmd+K / ctrl+K to toggle
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (backdrop.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }
  }
  
  // Event listeners
  document.addEventListener('keydown', handleKeyDown);
  
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeSearch();
  });
  
  input.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = window.setTimeout(() => {
      performSearch((e.target as HTMLInputElement).value);
    }, 150);
  });
  
  // Expose open function globally for nav link
  (window as any).openSearch = openSearch;
  
  // Handle search links
  document.querySelectorAll('a[href="/search"]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      openSearch();
    });
  });
</script>
