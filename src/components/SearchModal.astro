---
// SearchModal.astro - cmd+K style search popover with Pagefind
---

<!-- Search Modal Backdrop -->
<div 
  id="search-modal-backdrop" 
  class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-200"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Modal Container -->
  <div class="fixed inset-x-4 top-[10vh] md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-2xl z-50">
    <div id="search-modal" class="bg-[#1a1a1a] rounded-xl shadow-2xl border border-white/10 overflow-hidden transform scale-95 opacity-0 transition-all duration-200">
      <h2 id="search-modal-title" class="sr-only">Search episodes</h2>
      <!-- Search Header -->
      <div class="flex items-center gap-3 px-4 py-3 border-b border-white/5">
        <svg class="w-5 h-5 text-[#8a8a8a] shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <label for="search-input" class="sr-only">Search episodes</label>
        <input 
          type="text" 
          id="search-input"
          placeholder="Search episodes..."
          class="flex-1 text-lg outline-none bg-transparent text-white placeholder:text-[#8a8a8a] focus:ring-0"
          autocomplete="off"
          autocapitalize="off"
          aria-describedby="search-empty"
        />
        <kbd class="hidden sm:inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#8a8a8a] bg-white/5 rounded border border-white/10">
          ESC
        </kbd>
      </div>
      
      <!-- Search Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <div id="search-empty" class="px-4 py-8 text-center text-[#8a8a8a]">
          <p>Type to search episodes, show notes, and transcripts</p>
          <p class="text-sm mt-2 text-[#8a8a8a]/60">
            <kbd class="px-1.5 py-0.5 text-xs bg-white/5 rounded border border-white/10">↑</kbd>
            <kbd class="px-1.5 py-0.5 text-xs bg-white/5 rounded border border-white/10">↓</kbd>
            to navigate
            <kbd class="px-1.5 py-0.5 text-xs bg-white/5 rounded border border-white/10 ml-2">↵</kbd>
            to select
          </p>
        </div>
        
        <div id="search-loading" class="px-4 py-8 text-center text-[#8a8a8a] hidden">
          <div class="inline-flex items-center gap-2">
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Searching...
          </div>
        </div>
        
        <div id="search-no-results" class="px-4 py-8 text-center text-[#8a8a8a] hidden">
          No results found
        </div>
        
        <ul id="search-results-list" class="divide-y divide-white/5 hidden"></ul>
      </div>
      
      <div class="px-4 py-2 border-t border-white/5 bg-[#141414] text-xs text-[#8a8a8a]/60 flex items-center justify-between">
        <span>Powered by PerezCarreno & Coindreau</span>
        <span class="hidden sm:inline">
          <kbd class="px-1.5 py-0.5 bg-white/5 rounded border border-white/10">⌘</kbd>
          <kbd class="px-1.5 py-0.5 bg-white/5 rounded border border-white/10">K</kbd>
          to toggle
        </span>
      </div>
    </div>
  </div>
</div>

<style is:global>
  #search-results-list li {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.15s;
  }
  
  #search-results-list li:hover,
  #search-results-list li.selected {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  #search-results-list li.selected {
    background-color: rgba(230, 51, 41, 0.08);
  }
  
  #search-results-list .result-title {
    font-weight: 600;
    font-family: var(--font-display);
    color: #fff;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
  }
  
  #search-results-list .result-excerpt {
    font-size: 0.875rem;
    color: #8a8a8a;
    margin-top: 0.25rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
  
  #search-results-list mark {
    background-color: rgba(230, 51, 41, 0.3);
    color: #fff;
    border-radius: 0.125rem;
    padding: 0 0.125rem;
  }
  
  #search-results-list .sub-results {
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  #search-results-list .sub-results > * + * {
    margin-top: 0.25rem;
  }
  
  #search-results-list .sub-result {
    font-size: 0.875rem;
    color: #8a8a8a;
  }
  
  #search-results-list .sub-result:hover {
    color: #e63329;
  }
</style>

<script>
  let pagefind: any = null;
  let selectedIndex = -1;
  let results: any[] = [];
  
  const backdrop = document.getElementById('search-modal-backdrop')!;
  const modal = document.getElementById('search-modal')!;
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsList = document.getElementById('search-results-list')!;
  const emptyState = document.getElementById('search-empty')!;
  const loadingState = document.getElementById('search-loading')!;
  const noResults = document.getElementById('search-no-results')!;
  
  async function initPagefind() {
    if (pagefind) return pagefind;
    try {
      const pagefindPath = '/pagefind/pagefind.js';
      pagefind = await import(/* @vite-ignore */ pagefindPath);
      await pagefind.options({ excerptLength: 15 });
      return pagefind;
    } catch (e) {
      console.error('Failed to load Pagefind:', e);
      return null;
    }
  }
  
  function openSearch() {
    backdrop.classList.remove('hidden');
    requestAnimationFrame(() => {
      backdrop.classList.remove('opacity-0');
      modal.classList.remove('scale-95', 'opacity-0');
    });
    input.focus();
    document.body.style.overflow = 'hidden';
    initPagefind();
  }
  
  function closeSearch() {
    backdrop.classList.add('opacity-0');
    modal.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      backdrop.classList.add('hidden');
      input.value = '';
      resetResults();
    }, 200);
    document.body.style.overflow = '';
  }
  
  function resetResults() {
    results = [];
    selectedIndex = -1;
    resultsList.innerHTML = '';
    resultsList.classList.add('hidden');
    loadingState.classList.add('hidden');
    noResults.classList.add('hidden');
    emptyState.classList.remove('hidden');
  }
  
  let searchTimeout: number;
  async function performSearch(query: string) {
    if (!query.trim()) { resetResults(); return; }
    const pf = await initPagefind();
    if (!pf) return;
    emptyState.classList.add('hidden');
    noResults.classList.add('hidden');
    resultsList.classList.add('hidden');
    loadingState.classList.remove('hidden');
    const search = await pf.search(query);
    results = search.results.slice(0, 10);
    loadingState.classList.add('hidden');
    if (results.length === 0) { noResults.classList.remove('hidden'); return; }
    resultsList.innerHTML = '';
    for (let i = 0; i < results.length; i++) {
      const data = await results[i].data();
      const li = document.createElement('li');
      li.dataset.index = String(i);
      li.dataset.url = data.meta?.url || data.url;
      let html = `<div class="result-title">${data.meta?.title || 'Untitled'}</div><div class="result-excerpt">${data.excerpt}</div>`;
      if (data.sub_results && data.sub_results.length > 1) {
        html += '<div class="sub-results">';
        for (const sub of data.sub_results.slice(1, 4)) {
          html += `<a href="${sub.url}" class="sub-result block">${sub.title}</a>`;
        }
        html += '</div>';
      }
      li.innerHTML = html;
      li.addEventListener('click', () => navigateToResult(i));
      resultsList.appendChild(li);
    }
    resultsList.classList.remove('hidden');
    selectedIndex = -1;
  }
  
  function navigateToResult(index: number) {
    if (results[index]) {
      results[index].data().then((data: any) => {
        window.location.href = data.meta?.url || data.url;
      });
    }
  }
  
  function updateSelection() {
    const items = resultsList.querySelectorAll('li');
    items.forEach((item, i) => { item.classList.toggle('selected', i === selectedIndex); });
    if (selectedIndex >= 0 && items[selectedIndex]) {
      items[selectedIndex].scrollIntoView({ block: 'nearest' });
    }
  }
  
  function handleKeyDown(e: KeyboardEvent) {
    if (!backdrop.classList.contains('hidden')) {
      if (e.key === 'Escape') closeSearch();
      else if (e.key === 'ArrowDown') { e.preventDefault(); if (results.length > 0) { selectedIndex = Math.min(selectedIndex + 1, results.length - 1); updateSelection(); } }
      else if (e.key === 'ArrowUp') { e.preventDefault(); if (results.length > 0) { selectedIndex = Math.max(selectedIndex - 1, 0); updateSelection(); } }
      else if (e.key === 'Enter' && selectedIndex >= 0) { e.preventDefault(); navigateToResult(selectedIndex); }
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      backdrop.classList.contains('hidden') ? openSearch() : closeSearch();
    }
  }
  
  document.addEventListener('keydown', handleKeyDown);
  backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeSearch(); });
  input.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = window.setTimeout(() => performSearch((e.target as HTMLInputElement).value), 150);
  });
  (window as any).openSearch = openSearch;
  document.querySelectorAll('a[href="/search"]').forEach(link => {
    link.addEventListener('click', (e) => { e.preventDefault(); openSearch(); });
  });
</script>
